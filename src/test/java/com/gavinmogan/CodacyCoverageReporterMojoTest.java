package com.gavinmogan;

import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugin.testing.MojoRule;
import org.codehaus.plexus.PlexusTestCase;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.mockserver.client.MockServerClient;
import org.mockserver.junit.MockServerRule;
import org.mockserver.socket.tls.KeyStoreFactory;

import java.io.File;

import static junit.framework.TestCase.assertTrue;
import static org.junit.Assert.assertNotNull;
import static org.mockserver.model.Header.header;
import static org.mockserver.model.HttpRequest.request;
import static org.mockserver.model.HttpResponse.response;

public class CodacyCoverageReporterMojoTest {
    private File pom;
    private CodacyCoverageReporterMojo codacyCoverageReporterMojo;

    @Rule
    public MojoRule rule = new MojoRule();

    @Rule
    public MockServerRule mockServerRule = new MockServerRule(this);
    private MockServerClient mockServerClient;

    @Before
    public void setUp() throws Exception {
        pom = PlexusTestCase.getTestFile( "src/test/resources/unit/project-to-test" );
        assertNotNull( pom );
        assertTrue( pom.exists() );

        KeyStoreFactory.keyStoreFactory().loadOrCreateKeyStore();

        codacyCoverageReporterMojo = (CodacyCoverageReporterMojo) rule.lookupConfiguredMojo( pom, "coverage" );
        assertNotNull( codacyCoverageReporterMojo );
        codacyCoverageReporterMojo.setCodacyApiBaseUrl("http://localhost:" + mockServerRule.getPort());
        codacyCoverageReporterMojo.setCommit("FAKECOMMIT");
        codacyCoverageReporterMojo.setApiToken("FAKE_API_TOKEN");
        codacyCoverageReporterMojo.setProjectToken("FAKE_PROJECT_TOKEN");

    }

    @Test
    public void testJacoco() throws Exception {
        String body = "{\"total\":51,\"fileReports\":[{\"filename\":\"com/saucelabs/ci/OperatingSystemDescription.java\",\"total\":100,\"coverage\":{\"10\":1,\"37\":1,\"25\":1,\"52\":1,\"14\":1,\"28\":1,\"33\":1,\"9\":1,\"13\":1,\"32\":1,\"17\":1,\"22\":1,\"12\":1,\"48\":1,\"18\":1,\"50\":1,\"16\":1,\"31\":1,\"11\":1,\"26\":1,\"30\":1,\"47\":1,\"15\":1}},{\"filename\":\"com/saucelabs/ci/Browser.java\",\"total\":46,\"coverage\":{\"101\":0,\"120\":0,\"42\":1,\"125\":0,\"46\":1,\"152\":1,\"78\":0,\"29\":1,\"106\":0,\"84\":0,\"147\":1,\"61\":1,\"132\":0,\"133\":0,\"117\":0,\"85\":0,\"28\":1,\"38\":1,\"160\":1,\"70\":1,\"137\":0,\"33\":1,\"92\":0,\"65\":1,\"97\":0,\"109\":0,\"77\":0,\"129\":0,\"134\":0,\"73\":1,\"32\":1,\"34\":1,\"64\":0,\"59\":1,\"118\":0,\"27\":1,\"54\":1,\"144\":1,\"86\":0,\"159\":1,\"113\":1,\"81\":0,\"98\":0,\"103\":0,\"91\":0,\"155\":1,\"130\":0,\"80\":0,\"167\":1,\"35\":1,\"95\":0,\"50\":1,\"67\":0,\"31\":1,\"143\":1,\"104\":0,\"171\":1,\"139\":0,\"82\":0,\"151\":1,\"30\":1,\"107\":0,\"136\":0,\"94\":0,\"131\":0,\"163\":1,\"68\":1,\"62\":1,\"90\":0,\"83\":0,\"100\":0}},{\"filename\":\"com/saucelabs/ci/JobInformation.java\",\"total\":81,\"coverage\":{\"69\":1,\"88\":1,\"170\":1,\"217\":0,\"276\":1,\"247\":1,\"269\":1,\"153\":1,\"42\":1,\"125\":1,\"196\":1,\"189\":1,\"152\":1,\"289\":1,\"216\":0,\"179\":1,\"211\":0,\"238\":1,\"280\":1,\"61\":1,\"221\":0,\"133\":1,\"265\":1,\"206\":1,\"60\":1,\"270\":1,\"220\":0,\"297\":1,\"33\":1,\"97\":1,\"285\":1,\"224\":0,\"188\":1,\"169\":1,\"124\":1,\"225\":0,\"96\":1,\"41\":1,\"105\":1,\"266\":1,\"205\":1,\"264\":1,\"161\":1,\"279\":1,\"296\":1,\"281\":1,\"204\":1,\"236\":1,\"187\":1,\"172\":1,\"219\":0,\"274\":1,\"245\":1,\"213\":0,\"278\":1,\"223\":0,\"241\":1,\"123\":1,\"282\":1,\"95\":1,\"154\":1,\"143\":1,\"43\":1,\"250\":1,\"231\":0,\"87\":1,\"218\":0,\"40\":1,\"114\":1,\"235\":1,\"246\":1,\"272\":1,\"51\":1,\"273\":1,\"305\":1,\"210\":0,\"268\":1,\"79\":1,\"277\":1,\"215\":0,\"222\":0}},{\"filename\":\"com/saucelabs/ci/CacheTimeUtil.java\",\"total\":75,\"coverage\":{\"24\":1,\"37\":1,\"25\":1,\"20\":1,\"34\":1,\"17\":0,\"16\":0,\"31\":1}},{\"filename\":\"com/saucelabs/ci/SeleniumVersion.java\",\"total\":0,\"coverage\":{\"13\":0,\"12\":0,\"7\":0,\"16\":0,\"11\":0,\"8\":0}},{\"filename\":\"com/saucelabs/ci/BrowserFactory.java\",\"total\":65,\"coverage\":{\"69\":1,\"138\":1,\"101\":1,\"249\":0,\"170\":1,\"115\":1,\"120\":1,\"202\":1,\"56\":0,\"142\":1,\"185\":1,\"42\":0,\"320\":0,\"257\":0,\"52\":1,\"184\":1,\"46\":1,\"93\":1,\"284\":0,\"152\":1,\"289\":0,\"57\":0,\"216\":1,\"164\":1,\"179\":1,\"211\":1,\"253\":0,\"106\":1,\"238\":0,\"121\":0,\"147\":1,\"280\":0,\"221\":1,\"293\":0,\"206\":1,\"292\":0,\"248\":0,\"60\":1,\"201\":1,\"220\":1,\"102\":1,\"275\":0,\"137\":1,\"33\":1,\"92\":1,\"197\":1,\"65\":0,\"97\":1,\"285\":0,\"156\":1,\"53\":1,\"169\":1,\"256\":0,\"77\":0,\"212\":1,\"96\":1,\"134\":1,\"237\":0,\"105\":1,\"205\":1,\"166\":1,\"34\":1,\"45\":1,\"64\":1,\"180\":1,\"149\":1,\"191\":1,\"286\":0,\"291\":0,\"59\":1,\"281\":0,\"27\":1,\"71\":1,\"54\":0,\"49\":1,\"236\":0,\"159\":1,\"187\":1,\"172\":1,\"113\":0,\"81\":1,\"76\":1,\"245\":0,\"271\":0,\"208\":1,\"103\":1,\"140\":1,\"91\":1,\"240\":0,\"251\":0,\"267\":0,\"35\":1,\"162\":1,\"255\":0,\"209\":1,\"112\":1,\"123\":1,\"145\":0,\"150\":1,\"95\":1,\"67\":1,\"199\":1,\"177\":1,\"154\":1,\"175\":1,\"143\":1,\"43\":0,\"250\":0,\"87\":1,\"203\":1,\"218\":1,\"104\":1,\"319\":0,\"304\":0,\"158\":1,\"186\":1,\"171\":1,\"290\":0,\"119\":1,\"58\":0,\"246\":0,\"272\":0,\"287\":0,\"151\":1,\"315\":0,\"36\":1,\"273\":0,\"210\":1,\"107\":1,\"136\":1,\"79\":1,\"195\":1,\"94\":1,\"47\":0,\"163\":1,\"200\":1,\"178\":1,\"111\":1,\"254\":0,\"322\":0,\"83\":1,\"222\":1,\"232\":0}},{\"filename\":\"com/saucelabs/ci/SODSeleniumConfiguration.java\",\"total\":0,\"coverage\":{\"69\":0,\"101\":0,\"56\":0,\"142\":0,\"185\":0,\"37\":0,\"196\":0,\"46\":0,\"152\":0,\"106\":0,\"121\":0,\"132\":0,\"116\":0,\"60\":0,\"102\":0,\"38\":0,\"192\":0,\"21\":0,\"92\":0,\"65\":0,\"156\":0,\"188\":0,\"53\":0,\"141\":0,\"96\":0,\"73\":0,\"166\":0,\"34\":0,\"45\":0,\"161\":0,\"64\":0,\"180\":0,\"59\":0,\"49\":0,\"181\":0,\"86\":0,\"172\":0,\"81\":0,\"76\":0,\"39\":0,\"91\":0,\"35\":0,\"162\":0,\"112\":0,\"48\":0,\"63\":0,\"50\":0,\"199\":0,\"177\":0,\"182\":0,\"72\":0,\"203\":0,\"186\":0,\"55\":0,\"171\":0,\"82\":0,\"151\":0,\"36\":0,\"146\":0,\"51\":0,\"126\":0,\"136\":0,\"195\":0,\"131\":0,\"47\":0,\"200\":0,\"68\":0,\"111\":0,\"122\":0}},{\"filename\":\"com/saucelabs/ci/SeleniumBuilderManager.java\",\"total\":0,\"coverage\":{\"69\":0,\"138\":0,\"101\":0,\"333\":0,\"234\":0,\"88\":0,\"170\":0,\"115\":0,\"217\":0,\"276\":0,\"269\":0,\"153\":0,\"288\":0,\"257\":0,\"184\":0,\"110\":0,\"125\":0,\"196\":0,\"46\":0,\"93\":0,\"284\":0,\"325\":0,\"78\":0,\"179\":0,\"321\":0,\"121\":0,\"84\":0,\"221\":0,\"293\":0,\"132\":0,\"89\":0,\"133\":0,\"116\":0,\"312\":0,\"233\":0,\"248\":0,\"270\":0,\"201\":0,\"102\":0,\"260\":0,\"275\":0,\"137\":0,\"92\":0,\"229\":0,\"252\":0,\"197\":0,\"97\":0,\"329\":0,\"324\":0,\"317\":0,\"156\":0,\"141\":0,\"109\":0,\"328\":0,\"225\":0,\"77\":0,\"41\":0,\"134\":0,\"73\":0,\"266\":0,\"205\":0,\"311\":0,\"148\":0,\"264\":0,\"180\":0,\"296\":0,\"149\":0,\"118\":0,\"281\":0,\"71\":0,\"335\":0,\"236\":0,\"181\":0,\"86\":0,\"172\":0,\"113\":0,\"81\":0,\"76\":0,\"245\":0,\"318\":0,\"98\":0,\"303\":0,\"103\":0,\"140\":0,\"213\":0,\"91\":0,\"240\":0,\"251\":0,\"155\":0,\"198\":0,\"108\":0,\"130\":0,\"278\":0,\"135\":0,\"226\":0,\"80\":0,\"209\":0,\"112\":0,\"123\":0,\"145\":0,\"282\":0,\"95\":0,\"327\":0,\"263\":0,\"310\":0,\"177\":0,\"182\":0,\"331\":0,\"127\":0,\"336\":0,\"154\":0,\"72\":0,\"143\":0,\"99\":0,\"87\":0,\"258\":0,\"75\":0,\"290\":0,\"119\":0,\"246\":0,\"272\":0,\"82\":0,\"287\":0,\"151\":0,\"168\":0,\"146\":0,\"183\":0,\"326\":0,\"107\":0,\"239\":0,\"242\":0,\"294\":0,\"136\":0,\"79\":0,\"195\":0,\"332\":0,\"131\":0,\"178\":0,\"254\":0,\"227\":0,\"322\":0,\"337\":0,\"122\":0,\"232\":0,\"100\":0}},{\"filename\":\"com/saucelabs/ci/sauceconnect/TunnelInformation.java\",\"total\":87,\"coverage\":{\"37\":1,\"25\":0,\"46\":1,\"29\":1,\"38\":1,\"21\":1,\"33\":1,\"13\":1,\"41\":0,\"45\":1,\"17\":1,\"12\":1,\"18\":1,\"50\":1,\"16\":1,\"30\":1}},{\"filename\":\"com/saucelabs/ci/sauceconnect/SauceConnectFourManager.java\",\"total\":67,\"coverage\":{\"347\":1,\"333\":0,\"115\":1,\"217\":0,\"202\":1,\"384\":0,\"56\":1,\"340\":1,\"185\":1,\"288\":1,\"301\":1,\"320\":1,\"37\":1,\"25\":1,\"389\":0,\"52\":0,\"344\":1,\"357\":1,\"196\":1,\"325\":0,\"289\":1,\"78\":1,\"261\":1,\"29\":1,\"216\":0,\"164\":1,\"211\":1,\"84\":0,\"397\":0,\"280\":1,\"61\":0,\"293\":1,\"89\":1,\"243\":1,\"265\":0,\"74\":1,\"248\":1,\"380\":0,\"85\":0,\"381\":0,\"220\":1,\"302\":1,\"260\":1,\"28\":1,\"38\":1,\"70\":1,\"165\":1,\"92\":1,\"197\":1,\"329\":1,\"324\":1,\"224\":0,\"156\":1,\"188\":0,\"53\":1,\"124\":0,\"225\":0,\"339\":0,\"193\":1,\"212\":0,\"393\":0,\"41\":1,\"73\":1,\"244\":1,\"205\":0,\"398\":0,\"45\":1,\"191\":1,\"402\":0,\"44\":1,\"291\":1,\"281\":1,\"204\":1,\"259\":1,\"27\":1,\"382\":0,\"49\":1,\"335\":1,\"350\":1,\"187\":1,\"81\":1,\"377\":0,\"362\":1,\"76\":1,\"245\":1,\"39\":1,\"303\":1,\"271\":1,\"345\":0,\"103\":1,\"213\":0,\"240\":1,\"155\":1,\"330\":1,\"223\":1,\"394\":0,\"267\":1,\"241\":1,\"342\":1,\"194\":0,\"48\":1,\"282\":0,\"95\":0,\"263\":1,\"50\":0,\"199\":0,\"331\":1,\"338\":0,\"72\":1,\"314\":1,\"99\":1,\"87\":1,\"203\":1,\"40\":1,\"304\":1,\"390\":0,\"186\":1,\"55\":1,\"401\":0,\"75\":1,\"290\":1,\"119\":1,\"58\":0,\"378\":0,\"246\":0,\"207\":1,\"346\":0,\"82\":0,\"214\":0,\"287\":1,\"300\":1,\"315\":1,\"36\":1,\"262\":1,\"30\":1,\"51\":1,\"405\":0,\"190\":1,\"305\":1,\"210\":1,\"326\":0,\"107\":1,\"239\":1,\"242\":1,\"79\":1,\"400\":0,\"283\":0,\"395\":0,\"332\":0,\"131\":1,\"90\":0,\"111\":1,\"322\":1,\"337\":1,\"83\":0,\"222\":1}},{\"filename\":\"com/saucelabs/ci/sauceconnect/AbstractSauceTunnelManager.java\",\"total\":65,\"coverage\":{\"69\":0,\"365\":0,\"88\":0,\"408\":0,\"582\":1,\"276\":1,\"120\":1,\"379\":1,\"440\":1,\"511\":1,\"385\":1,\"384\":1,\"533\":0,\"550\":1,\"500\":1,\"472\":0,\"340\":0,\"174\":1,\"185\":1,\"42\":1,\"372\":0,\"110\":1,\"619\":1,\"344\":0,\"196\":1,\"189\":1,\"46\":1,\"93\":0,\"284\":1,\"325\":1,\"289\":1,\"475\":0,\"164\":1,\"443\":1,\"321\":1,\"623\":0,\"211\":1,\"253\":0,\"485\":1,\"106\":1,\"121\":1,\"514\":0,\"348\":0,\"84\":0,\"147\":1,\"280\":1,\"293\":1,\"453\":1,\"89\":0,\"411\":1,\"116\":1,\"428\":0,\"307\":0,\"452\":0,\"380\":1,\"117\":0,\"512\":1,\"439\":1,\"529\":0,\"381\":1,\"366\":0,\"102\":1,\"334\":1,\"160\":1,\"70\":0,\"137\":0,\"165\":1,\"92\":0,\"229\":1,\"566\":1,\"252\":0,\"97\":0,\"329\":1,\"551\":1,\"324\":1,\"285\":1,\"519\":1,\"578\":1,\"188\":1,\"388\":0,\"53\":1,\"169\":1,\"593\":1,\"499\":1,\"109\":1,\"328\":1,\"471\":0,\"124\":1,\"225\":1,\"339\":0,\"77\":0,\"476\":0,\"212\":1,\"622\":0,\"134\":0,\"360\":1,\"508\":1,\"530\":0,\"298\":0,\"412\":1,\"618\":1,\"166\":1,\"148\":1,\"573\":1,\"444\":1,\"375\":1,\"191\":1,\"59\":1,\"281\":1,\"413\":1,\"71\":0,\"391\":0,\"382\":1,\"54\":1,\"572\":1,\"313\":0,\"498\":1,\"335\":1,\"86\":0,\"159\":1,\"187\":1,\"406\":1,\"172\":1,\"113\":1,\"274\":0,\"81\":0,\"377\":1,\"362\":1,\"76\":0,\"318\":1,\"509\":1,\"434\":1,\"98\":0,\"208\":1,\"387\":1,\"631\":1,\"367\":0,\"552\":1,\"535\":1,\"103\":1,\"609\":1,\"323\":1,\"213\":1,\"91\":0,\"520\":1,\"251\":0,\"330\":1,\"608\":1,\"394\":1,\"306\":0,\"135\":0,\"226\":1,\"438\":1,\"431\":1,\"80\":0,\"167\":1,\"473\":0,\"426\":1,\"589\":1,\"374\":0,\"209\":1,\"112\":1,\"516\":0,\"123\":1,\"194\":1,\"580\":1,\"282\":0,\"150\":1,\"310\":0,\"182\":1,\"331\":1,\"441\":1,\"585\":1,\"370\":0,\"576\":1,\"359\":1,\"336\":1,\"72\":0,\"386\":1,\"314\":0,\"446\":0,\"497\":1,\"450\":0,\"99\":0,\"87\":0,\"517\":0,\"319\":1,\"40\":1,\"351\":0,\"390\":0,\"186\":1,\"55\":1,\"632\":1,\"75\":0,\"568\":0,\"290\":1,\"119\":1,\"58\":1,\"378\":1,\"478\":0,\"346\":0,\"549\":1,\"82\":0,\"151\":1,\"315\":0,\"432\":1,\"410\":1,\"30\":1,\"183\":0,\"273\":1,\"564\":1,\"305\":0,\"210\":1,\"326\":1,\"107\":0,\"136\":0,\"341\":0,\"79\":0,\"437\":1,\"474\":0,\"532\":0,\"415\":1,\"395\":1,\"332\":1,\"575\":1,\"528\":1,\"163\":1,\"277\":1,\"442\":1,\"501\":1,\"369\":0,\"607\":1,\"111\":1,\"227\":1,\"322\":1,\"337\":0,\"122\":1,\"354\":0,\"215\":1,\"454\":1}}]}";
        setupMockServer(body, "testJacoco");

        codacyCoverageReporterMojo.setCommit("testJacoco");
        codacyCoverageReporterMojo.setCoverageReportFile(new File(pom, "jacoco/jacoco.xml"));
        codacyCoverageReporterMojo.execute();
    }

    @Test
    public void testCobertura() throws Exception {
        String body = "{\"total\":25,\"fileReports\":[{\"filename\":\"com/gavinmogan/CodacyCoverageReporterMojo.java\",\"total\":81,\"coverage\":{\"88\":2,\"115\":0,\"217\":2,\"120\":2,\"153\":1,\"185\":3,\"125\":1,\"196\":0,\"93\":0,\"228\":2,\"216\":2,\"164\":4,\"121\":1,\"221\":0,\"132\":2,\"133\":2,\"233\":2,\"201\":4,\"220\":0,\"102\":2,\"160\":1,\"192\":0,\"137\":2,\"92\":0,\"229\":2,\"224\":4,\"188\":2,\"141\":2,\"109\":2,\"124\":1,\"225\":4,\"193\":0,\"212\":2,\"129\":2,\"134\":2,\"205\":2,\"148\":2,\"161\":2,\"180\":3,\"149\":2,\"191\":0,\"204\":2,\"144\":4,\"187\":3,\"113\":2,\"208\":2,\"103\":0,\"140\":2,\"213\":2,\"91\":0,\"135\":2,\"162\":0,\"209\":2,\"123\":1,\"194\":1,\"150\":1,\"182\":3,\"104\":0,\"158\":2,\"114\":0,\"139\":2,\"119\":2,\"151\":1,\"36\":2,\"168\":1,\"190\":0,\"183\":3,\"107\":2,\"126\":1,\"163\":0,\"200\":4,\"111\":2,\"122\":1,\"232\":2}},{\"filename\":\"com/gavinmogan/HelpMojo.java\",\"total\":0,\"coverage\":{\"69\":0,\"365\":0,\"138\":0,\"101\":0,\"234\":0,\"88\":0,\"408\":0,\"170\":0,\"115\":0,\"449\":0,\"120\":0,\"247\":0,\"379\":0,\"440\":0,\"269\":0,\"385\":0,\"340\":0,\"153\":0,\"404\":0,\"417\":0,\"288\":0,\"320\":0,\"436\":0,\"389\":0,\"125\":0,\"196\":0,\"157\":0,\"189\":0,\"284\":0,\"416\":0,\"228\":0,\"289\":0,\"316\":0,\"78\":0,\"261\":0,\"29\":0,\"84\":0,\"147\":0,\"280\":0,\"132\":0,\"243\":0,\"428\":0,\"265\":0,\"74\":0,\"292\":0,\"452\":0,\"117\":0,\"381\":0,\"220\":0,\"302\":0,\"260\":0,\"160\":0,\"70\":0,\"192\":0,\"275\":0,\"165\":0,\"92\":0,\"252\":0,\"285\":0,\"224\":0,\"356\":0,\"256\":0,\"339\":0,\"96\":0,\"129\":0,\"134\":0,\"73\":0,\"237\":0,\"244\":0,\"266\":0,\"360\":0,\"205\":0,\"298\":0,\"412\":0,\"430\":0,\"166\":0,\"148\":0,\"279\":0,\"296\":0,\"402\":0,\"286\":0,\"291\":0,\"204\":0,\"259\":0,\"391\":0,\"445\":0,\"144\":0,\"236\":0,\"86\":0,\"159\":0,\"406\":0,\"172\":0,\"219\":0,\"274\":0,\"362\":0,\"76\":0,\"318\":0,\"434\":0,\"98\":0,\"303\":0,\"208\":0,\"387\":0,\"323\":0,\"140\":0,\"213\":0,\"240\":0,\"155\":0,\"198\":0,\"130\":0,\"399\":0,\"299\":0,\"226\":0,\"241\":0,\"80\":0,\"112\":0,\"123\":0,\"194\":0,\"282\":0,\"263\":0,\"177\":0,\"338\":0,\"336\":0,\"446\":0,\"250\":0,\"203\":0,\"258\":0,\"390\":0,\"114\":0,\"401\":0,\"75\":0,\"119\":0,\"378\":0,\"235\":0,\"246\":0,\"207\":0,\"383\":0,\"82\":0,\"151\":0,\"432\":0,\"168\":0,\"190\":0,\"183\":0,\"210\":0,\"239\":0,\"294\":0,\"126\":0,\"358\":0,\"437\":0,\"395\":0,\"427\":0,\"131\":0,\"163\":0,\"277\":0,\"254\":0,\"354\":0,\"222\":0,\"100\":0}}]}";
        setupMockServer(body, "testCobertura");

        codacyCoverageReporterMojo.setCommit("testCobertura");
        codacyCoverageReporterMojo.setCoverageReportFile(new File(pom, "cobertura/coverage.xml"));
        codacyCoverageReporterMojo.execute();
    }

    @Test
    public void testCoberturaNotExistFailingOkay() throws Exception {
        String body = "{\"total\":25,\"fileReports\":[{\"filename\":\"com/gavinmogan/CodacyCoverageReporterMojo.java\",\"total\":81,\"coverage\":{\"205\":2,\"113\":2,\"120\":2,\"153\":1,\"158\":2,\"182\":3,\"216\":2,\"124\":1,\"164\":4,\"135\":2,\"121\":1,\"88\":2,\"141\":2,\"139\":2,\"132\":2,\"201\":4,\"212\":2,\"224\":4,\"134\":2,\"123\":1,\"107\":2,\"217\":2,\"209\":2,\"233\":2,\"144\":4,\"228\":2,\"188\":2,\"148\":2,\"213\":2,\"185\":3,\"137\":2,\"126\":1,\"36\":2,\"140\":2,\"180\":3,\"208\":2,\"133\":2,\"122\":1,\"111\":2,\"102\":2,\"151\":1,\"225\":4,\"109\":2,\"149\":2,\"160\":1,\"187\":3,\"125\":1,\"194\":1,\"183\":3,\"129\":2,\"168\":1,\"232\":2,\"150\":1,\"204\":2,\"229\":2,\"200\":4,\"119\":2,\"161\":2}}]}";
        setupMockServer(body, "testCoberturaNotExistFailingOkay");

        codacyCoverageReporterMojo.setCommit("testCoberturaNotExistFailingOkay");
        codacyCoverageReporterMojo.setCoverageReportFile(new File(pom, "cobertura/coverage-not-exist.xml"));
        codacyCoverageReporterMojo.setFailOnMissingReportFile(false);
        codacyCoverageReporterMojo.execute();
    }

    @Test(expected=MojoFailureException.class)
    public void testCoberturaNotExistFailingNotOkay() throws Exception {
        String body = "{\"total\":25,\"fileReports\":[{\"filename\":\"com/gavinmogan/CodacyCoverageReporterMojo.java\",\"total\":81,\"coverage\":{\"205\":2,\"113\":2,\"120\":2,\"153\":1,\"158\":2,\"182\":3,\"216\":2,\"124\":1,\"164\":4,\"135\":2,\"121\":1,\"88\":2,\"141\":2,\"139\":2,\"132\":2,\"201\":4,\"212\":2,\"224\":4,\"134\":2,\"123\":1,\"107\":2,\"217\":2,\"209\":2,\"233\":2,\"144\":4,\"228\":2,\"188\":2,\"148\":2,\"213\":2,\"185\":3,\"137\":2,\"126\":1,\"36\":2,\"140\":2,\"180\":3,\"208\":2,\"133\":2,\"122\":1,\"111\":2,\"102\":2,\"151\":1,\"225\":4,\"109\":2,\"149\":2,\"160\":1,\"187\":3,\"125\":1,\"194\":1,\"183\":3,\"129\":2,\"168\":1,\"232\":2,\"150\":1,\"204\":2,\"229\":2,\"200\":4,\"119\":2,\"161\":2}}]}";
        setupMockServer(body, "testCoberturaNotExistFailingNotOkay");

        codacyCoverageReporterMojo.setCommit("testCoberturaNotExistFailingNotOkay");
        codacyCoverageReporterMojo.setCoverageReportFile(new File(pom, "cobertura/coverage-not-exist.xml"));
        codacyCoverageReporterMojo.setFailOnMissingReportFile(true);
        codacyCoverageReporterMojo.execute();
    }

    @Test
    public void testExecuteWithHttpsFailingWithSelfSignedCertificatesUntrusted() throws Exception {
        testExecuteWithHttps(false, "testExecuteWithHttpsFailingWithSelfSignedCertificatesUntrusted");
    }

    @Test
    public void testExecuteWithHttpsSucceedingWithSelfSignedCertificatesTrusted() throws Exception {
        testExecuteWithHttps(true, "testExecuteWithHttpsSucceedingWithSelfSignedCertificatesTrusted");
    }

    private void testExecuteWithHttps(boolean trustSelfSignedCerts, String commit) throws Exception {
        String body = "{\"total\":51,\"fileReports\":[{\"filename\":\"com/saucelabs/ci/OperatingSystemDescription.java\",\"total\":100,\"coverage\":{\"10\":1,\"37\":1,\"25\":1,\"52\":1,\"14\":1,\"28\":1,\"33\":1,\"9\":1,\"13\":1,\"32\":1,\"17\":1,\"22\":1,\"12\":1,\"48\":1,\"18\":1,\"50\":1,\"16\":1,\"31\":1,\"11\":1,\"26\":1,\"30\":1,\"47\":1,\"15\":1}},{\"filename\":\"com/saucelabs/ci/Browser.java\",\"total\":46,\"coverage\":{\"101\":0,\"120\":0,\"42\":1,\"125\":0,\"46\":1,\"152\":1,\"78\":0,\"29\":1,\"106\":0,\"84\":0,\"147\":1,\"61\":1,\"132\":0,\"133\":0,\"117\":0,\"85\":0,\"28\":1,\"38\":1,\"160\":1,\"70\":1,\"137\":0,\"33\":1,\"92\":0,\"65\":1,\"97\":0,\"109\":0,\"77\":0,\"129\":0,\"134\":0,\"73\":1,\"32\":1,\"34\":1,\"64\":0,\"59\":1,\"118\":0,\"27\":1,\"54\":1,\"144\":1,\"86\":0,\"159\":1,\"113\":1,\"81\":0,\"98\":0,\"103\":0,\"91\":0,\"155\":1,\"130\":0,\"80\":0,\"167\":1,\"35\":1,\"95\":0,\"50\":1,\"67\":0,\"31\":1,\"143\":1,\"104\":0,\"171\":1,\"139\":0,\"82\":0,\"151\":1,\"30\":1,\"107\":0,\"136\":0,\"94\":0,\"131\":0,\"163\":1,\"68\":1,\"62\":1,\"90\":0,\"83\":0,\"100\":0}},{\"filename\":\"com/saucelabs/ci/JobInformation.java\",\"total\":81,\"coverage\":{\"69\":1,\"88\":1,\"170\":1,\"217\":0,\"276\":1,\"247\":1,\"269\":1,\"153\":1,\"42\":1,\"125\":1,\"196\":1,\"189\":1,\"152\":1,\"289\":1,\"216\":0,\"179\":1,\"211\":0,\"238\":1,\"280\":1,\"61\":1,\"221\":0,\"133\":1,\"265\":1,\"206\":1,\"60\":1,\"270\":1,\"220\":0,\"297\":1,\"33\":1,\"97\":1,\"285\":1,\"224\":0,\"188\":1,\"169\":1,\"124\":1,\"225\":0,\"96\":1,\"41\":1,\"105\":1,\"266\":1,\"205\":1,\"264\":1,\"161\":1,\"279\":1,\"296\":1,\"281\":1,\"204\":1,\"236\":1,\"187\":1,\"172\":1,\"219\":0,\"274\":1,\"245\":1,\"213\":0,\"278\":1,\"223\":0,\"241\":1,\"123\":1,\"282\":1,\"95\":1,\"154\":1,\"143\":1,\"43\":1,\"250\":1,\"231\":0,\"87\":1,\"218\":0,\"40\":1,\"114\":1,\"235\":1,\"246\":1,\"272\":1,\"51\":1,\"273\":1,\"305\":1,\"210\":0,\"268\":1,\"79\":1,\"277\":1,\"215\":0,\"222\":0}},{\"filename\":\"com/saucelabs/ci/CacheTimeUtil.java\",\"total\":75,\"coverage\":{\"24\":1,\"37\":1,\"25\":1,\"20\":1,\"34\":1,\"17\":0,\"16\":0,\"31\":1}},{\"filename\":\"com/saucelabs/ci/SeleniumVersion.java\",\"total\":0,\"coverage\":{\"13\":0,\"12\":0,\"7\":0,\"16\":0,\"11\":0,\"8\":0}},{\"filename\":\"com/saucelabs/ci/BrowserFactory.java\",\"total\":65,\"coverage\":{\"69\":1,\"138\":1,\"101\":1,\"249\":0,\"170\":1,\"115\":1,\"120\":1,\"202\":1,\"56\":0,\"142\":1,\"185\":1,\"42\":0,\"320\":0,\"257\":0,\"52\":1,\"184\":1,\"46\":1,\"93\":1,\"284\":0,\"152\":1,\"289\":0,\"57\":0,\"216\":1,\"164\":1,\"179\":1,\"211\":1,\"253\":0,\"106\":1,\"238\":0,\"121\":0,\"147\":1,\"280\":0,\"221\":1,\"293\":0,\"206\":1,\"292\":0,\"248\":0,\"60\":1,\"201\":1,\"220\":1,\"102\":1,\"275\":0,\"137\":1,\"33\":1,\"92\":1,\"197\":1,\"65\":0,\"97\":1,\"285\":0,\"156\":1,\"53\":1,\"169\":1,\"256\":0,\"77\":0,\"212\":1,\"96\":1,\"134\":1,\"237\":0,\"105\":1,\"205\":1,\"166\":1,\"34\":1,\"45\":1,\"64\":1,\"180\":1,\"149\":1,\"191\":1,\"286\":0,\"291\":0,\"59\":1,\"281\":0,\"27\":1,\"71\":1,\"54\":0,\"49\":1,\"236\":0,\"159\":1,\"187\":1,\"172\":1,\"113\":0,\"81\":1,\"76\":1,\"245\":0,\"271\":0,\"208\":1,\"103\":1,\"140\":1,\"91\":1,\"240\":0,\"251\":0,\"267\":0,\"35\":1,\"162\":1,\"255\":0,\"209\":1,\"112\":1,\"123\":1,\"145\":0,\"150\":1,\"95\":1,\"67\":1,\"199\":1,\"177\":1,\"154\":1,\"175\":1,\"143\":1,\"43\":0,\"250\":0,\"87\":1,\"203\":1,\"218\":1,\"104\":1,\"319\":0,\"304\":0,\"158\":1,\"186\":1,\"171\":1,\"290\":0,\"119\":1,\"58\":0,\"246\":0,\"272\":0,\"287\":0,\"151\":1,\"315\":0,\"36\":1,\"273\":0,\"210\":1,\"107\":1,\"136\":1,\"79\":1,\"195\":1,\"94\":1,\"47\":0,\"163\":1,\"200\":1,\"178\":1,\"111\":1,\"254\":0,\"322\":0,\"83\":1,\"222\":1,\"232\":0}},{\"filename\":\"com/saucelabs/ci/SODSeleniumConfiguration.java\",\"total\":0,\"coverage\":{\"69\":0,\"101\":0,\"56\":0,\"142\":0,\"185\":0,\"37\":0,\"196\":0,\"46\":0,\"152\":0,\"106\":0,\"121\":0,\"132\":0,\"116\":0,\"60\":0,\"102\":0,\"38\":0,\"192\":0,\"21\":0,\"92\":0,\"65\":0,\"156\":0,\"188\":0,\"53\":0,\"141\":0,\"96\":0,\"73\":0,\"166\":0,\"34\":0,\"45\":0,\"161\":0,\"64\":0,\"180\":0,\"59\":0,\"49\":0,\"181\":0,\"86\":0,\"172\":0,\"81\":0,\"76\":0,\"39\":0,\"91\":0,\"35\":0,\"162\":0,\"112\":0,\"48\":0,\"63\":0,\"50\":0,\"199\":0,\"177\":0,\"182\":0,\"72\":0,\"203\":0,\"186\":0,\"55\":0,\"171\":0,\"82\":0,\"151\":0,\"36\":0,\"146\":0,\"51\":0,\"126\":0,\"136\":0,\"195\":0,\"131\":0,\"47\":0,\"200\":0,\"68\":0,\"111\":0,\"122\":0}},{\"filename\":\"com/saucelabs/ci/SeleniumBuilderManager.java\",\"total\":0,\"coverage\":{\"69\":0,\"138\":0,\"101\":0,\"333\":0,\"234\":0,\"88\":0,\"170\":0,\"115\":0,\"217\":0,\"276\":0,\"269\":0,\"153\":0,\"288\":0,\"257\":0,\"184\":0,\"110\":0,\"125\":0,\"196\":0,\"46\":0,\"93\":0,\"284\":0,\"325\":0,\"78\":0,\"179\":0,\"321\":0,\"121\":0,\"84\":0,\"221\":0,\"293\":0,\"132\":0,\"89\":0,\"133\":0,\"116\":0,\"312\":0,\"233\":0,\"248\":0,\"270\":0,\"201\":0,\"102\":0,\"260\":0,\"275\":0,\"137\":0,\"92\":0,\"229\":0,\"252\":0,\"197\":0,\"97\":0,\"329\":0,\"324\":0,\"317\":0,\"156\":0,\"141\":0,\"109\":0,\"328\":0,\"225\":0,\"77\":0,\"41\":0,\"134\":0,\"73\":0,\"266\":0,\"205\":0,\"311\":0,\"148\":0,\"264\":0,\"180\":0,\"296\":0,\"149\":0,\"118\":0,\"281\":0,\"71\":0,\"335\":0,\"236\":0,\"181\":0,\"86\":0,\"172\":0,\"113\":0,\"81\":0,\"76\":0,\"245\":0,\"318\":0,\"98\":0,\"303\":0,\"103\":0,\"140\":0,\"213\":0,\"91\":0,\"240\":0,\"251\":0,\"155\":0,\"198\":0,\"108\":0,\"130\":0,\"278\":0,\"135\":0,\"226\":0,\"80\":0,\"209\":0,\"112\":0,\"123\":0,\"145\":0,\"282\":0,\"95\":0,\"327\":0,\"263\":0,\"310\":0,\"177\":0,\"182\":0,\"331\":0,\"127\":0,\"336\":0,\"154\":0,\"72\":0,\"143\":0,\"99\":0,\"87\":0,\"258\":0,\"75\":0,\"290\":0,\"119\":0,\"246\":0,\"272\":0,\"82\":0,\"287\":0,\"151\":0,\"168\":0,\"146\":0,\"183\":0,\"326\":0,\"107\":0,\"239\":0,\"242\":0,\"294\":0,\"136\":0,\"79\":0,\"195\":0,\"332\":0,\"131\":0,\"178\":0,\"254\":0,\"227\":0,\"322\":0,\"337\":0,\"122\":0,\"232\":0,\"100\":0}},{\"filename\":\"com/saucelabs/ci/sauceconnect/TunnelInformation.java\",\"total\":87,\"coverage\":{\"37\":1,\"25\":0,\"46\":1,\"29\":1,\"38\":1,\"21\":1,\"33\":1,\"13\":1,\"41\":0,\"45\":1,\"17\":1,\"12\":1,\"18\":1,\"50\":1,\"16\":1,\"30\":1}},{\"filename\":\"com/saucelabs/ci/sauceconnect/SauceConnectFourManager.java\",\"total\":67,\"coverage\":{\"347\":1,\"333\":0,\"115\":1,\"217\":0,\"202\":1,\"384\":0,\"56\":1,\"340\":1,\"185\":1,\"288\":1,\"301\":1,\"320\":1,\"37\":1,\"25\":1,\"389\":0,\"52\":0,\"344\":1,\"357\":1,\"196\":1,\"325\":0,\"289\":1,\"78\":1,\"261\":1,\"29\":1,\"216\":0,\"164\":1,\"211\":1,\"84\":0,\"397\":0,\"280\":1,\"61\":0,\"293\":1,\"89\":1,\"243\":1,\"265\":0,\"74\":1,\"248\":1,\"380\":0,\"85\":0,\"381\":0,\"220\":1,\"302\":1,\"260\":1,\"28\":1,\"38\":1,\"70\":1,\"165\":1,\"92\":1,\"197\":1,\"329\":1,\"324\":1,\"224\":0,\"156\":1,\"188\":0,\"53\":1,\"124\":0,\"225\":0,\"339\":0,\"193\":1,\"212\":0,\"393\":0,\"41\":1,\"73\":1,\"244\":1,\"205\":0,\"398\":0,\"45\":1,\"191\":1,\"402\":0,\"44\":1,\"291\":1,\"281\":1,\"204\":1,\"259\":1,\"27\":1,\"382\":0,\"49\":1,\"335\":1,\"350\":1,\"187\":1,\"81\":1,\"377\":0,\"362\":1,\"76\":1,\"245\":1,\"39\":1,\"303\":1,\"271\":1,\"345\":0,\"103\":1,\"213\":0,\"240\":1,\"155\":1,\"330\":1,\"223\":1,\"394\":0,\"267\":1,\"241\":1,\"342\":1,\"194\":0,\"48\":1,\"282\":0,\"95\":0,\"263\":1,\"50\":0,\"199\":0,\"331\":1,\"338\":0,\"72\":1,\"314\":1,\"99\":1,\"87\":1,\"203\":1,\"40\":1,\"304\":1,\"390\":0,\"186\":1,\"55\":1,\"401\":0,\"75\":1,\"290\":1,\"119\":1,\"58\":0,\"378\":0,\"246\":0,\"207\":1,\"346\":0,\"82\":0,\"214\":0,\"287\":1,\"300\":1,\"315\":1,\"36\":1,\"262\":1,\"30\":1,\"51\":1,\"405\":0,\"190\":1,\"305\":1,\"210\":1,\"326\":0,\"107\":1,\"239\":1,\"242\":1,\"79\":1,\"400\":0,\"283\":0,\"395\":0,\"332\":0,\"131\":1,\"90\":0,\"111\":1,\"322\":1,\"337\":1,\"83\":0,\"222\":1}},{\"filename\":\"com/saucelabs/ci/sauceconnect/AbstractSauceTunnelManager.java\",\"total\":65,\"coverage\":{\"69\":0,\"365\":0,\"88\":0,\"408\":0,\"582\":1,\"276\":1,\"120\":1,\"379\":1,\"440\":1,\"511\":1,\"385\":1,\"384\":1,\"533\":0,\"550\":1,\"500\":1,\"472\":0,\"340\":0,\"174\":1,\"185\":1,\"42\":1,\"372\":0,\"110\":1,\"619\":1,\"344\":0,\"196\":1,\"189\":1,\"46\":1,\"93\":0,\"284\":1,\"325\":1,\"289\":1,\"475\":0,\"164\":1,\"443\":1,\"321\":1,\"623\":0,\"211\":1,\"253\":0,\"485\":1,\"106\":1,\"121\":1,\"514\":0,\"348\":0,\"84\":0,\"147\":1,\"280\":1,\"293\":1,\"453\":1,\"89\":0,\"411\":1,\"116\":1,\"428\":0,\"307\":0,\"452\":0,\"380\":1,\"117\":0,\"512\":1,\"439\":1,\"529\":0,\"381\":1,\"366\":0,\"102\":1,\"334\":1,\"160\":1,\"70\":0,\"137\":0,\"165\":1,\"92\":0,\"229\":1,\"566\":1,\"252\":0,\"97\":0,\"329\":1,\"551\":1,\"324\":1,\"285\":1,\"519\":1,\"578\":1,\"188\":1,\"388\":0,\"53\":1,\"169\":1,\"593\":1,\"499\":1,\"109\":1,\"328\":1,\"471\":0,\"124\":1,\"225\":1,\"339\":0,\"77\":0,\"476\":0,\"212\":1,\"622\":0,\"134\":0,\"360\":1,\"508\":1,\"530\":0,\"298\":0,\"412\":1,\"618\":1,\"166\":1,\"148\":1,\"573\":1,\"444\":1,\"375\":1,\"191\":1,\"59\":1,\"281\":1,\"413\":1,\"71\":0,\"391\":0,\"382\":1,\"54\":1,\"572\":1,\"313\":0,\"498\":1,\"335\":1,\"86\":0,\"159\":1,\"187\":1,\"406\":1,\"172\":1,\"113\":1,\"274\":0,\"81\":0,\"377\":1,\"362\":1,\"76\":0,\"318\":1,\"509\":1,\"434\":1,\"98\":0,\"208\":1,\"387\":1,\"631\":1,\"367\":0,\"552\":1,\"535\":1,\"103\":1,\"609\":1,\"323\":1,\"213\":1,\"91\":0,\"520\":1,\"251\":0,\"330\":1,\"608\":1,\"394\":1,\"306\":0,\"135\":0,\"226\":1,\"438\":1,\"431\":1,\"80\":0,\"167\":1,\"473\":0,\"426\":1,\"589\":1,\"374\":0,\"209\":1,\"112\":1,\"516\":0,\"123\":1,\"194\":1,\"580\":1,\"282\":0,\"150\":1,\"310\":0,\"182\":1,\"331\":1,\"441\":1,\"585\":1,\"370\":0,\"576\":1,\"359\":1,\"336\":1,\"72\":0,\"386\":1,\"314\":0,\"446\":0,\"497\":1,\"450\":0,\"99\":0,\"87\":0,\"517\":0,\"319\":1,\"40\":1,\"351\":0,\"390\":0,\"186\":1,\"55\":1,\"632\":1,\"75\":0,\"568\":0,\"290\":1,\"119\":1,\"58\":1,\"378\":1,\"478\":0,\"346\":0,\"549\":1,\"82\":0,\"151\":1,\"315\":0,\"432\":1,\"410\":1,\"30\":1,\"183\":0,\"273\":1,\"564\":1,\"305\":0,\"210\":1,\"326\":1,\"107\":0,\"136\":0,\"341\":0,\"79\":0,\"437\":1,\"474\":0,\"532\":0,\"415\":1,\"395\":1,\"332\":1,\"575\":1,\"528\":1,\"163\":1,\"277\":1,\"442\":1,\"501\":1,\"369\":0,\"607\":1,\"111\":1,\"227\":1,\"322\":1,\"337\":0,\"122\":1,\"354\":0,\"215\":1,\"454\":1}}]}";
        setupMockServer(body, commit);

        codacyCoverageReporterMojo.setCommit(commit);
        codacyCoverageReporterMojo.setCodacyApiBaseUrl("https://" +mockServerRule.getClient().remoteAddress().getHostName()+":" + mockServerRule.getPort());
        codacyCoverageReporterMojo.setCoverageReportFile(new File(pom, "jacoco/jacoco.xml"));
        codacyCoverageReporterMojo.setTrustSelfSignedCerts(trustSelfSignedCerts);
        codacyCoverageReporterMojo.execute();
    }

    private void setupMockServer(String body, String commit) {
        mockServerClient
                .when(
                        request()
                                .withMethod("POST")
                                .withPath("/2.0/coverage/" + commit + "/java")
                                .withQueryStringParameter("partial", "false")
                                .withHeaders(
                                        header("content-type", "application/json"),
                                        header("api_token", "FAKE_API_TOKEN"),
                                        header("project_token", "FAKE_PROJECT_TOKEN")
                                )
                                .withBody(body)
                )
                .respond(
                        response()
                                .withStatusCode(200)
                );
    }
}
